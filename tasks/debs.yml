---
- name: Check which .deb packages are already installed
  ansible.builtin.command:
    cmd: "dpkg -s {{ item.name }}"
  loop: "{{ deb_packages }}"
  loop_control:
    label: "{{ item.name }}"
  register: deb_check
  failed_when: false
  changed_when: false

- name: Create temp directory for deb downloads
  ansible.builtin.tempfile:
    state: directory
    prefix: deb_packages_
  register: deb_temp_dir

- name: Download missing .deb packages
  ansible.builtin.command:
    cmd: "curl -fsSL -o {{ deb_temp_dir.path }}/{{ item.name }}.deb {{ item.url }}"
  loop: "{{ deb_packages }}"
  loop_control:
    label: "{{ item.name }}"
    index_var: idx
  when: deb_check.results[idx].rc != 0

- name: Install missing .deb packages
  ansible.builtin.apt:
    deb: "{{ deb_temp_dir.path }}/{{ item.name }}.deb"
    state: present
  loop: "{{ deb_packages }}"
  loop_control:
    label: "{{ item.name }}"
    index_var: idx
  when: deb_check.results[idx].rc != 0

- name: Fix missing dependencies
  ansible.builtin.command:
    cmd: apt-get install -f -y
  register: fix_deps
  changed_when: fix_deps.stdout is search('newly installed')

- name: Clean up temp directory
  ansible.builtin.file:
    path: "{{ deb_temp_dir.path }}"
    state: absent
